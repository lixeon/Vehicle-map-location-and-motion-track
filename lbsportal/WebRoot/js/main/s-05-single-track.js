(function(){var g="mk";var j=1000*5;var i=3;var e=null;var d=null;var a="";var h=1;var f=false;var c=function(m){if(f==true){vp.v.log.warn("正在定位，请稍后！");return}vp.v.log.info("正在下发定位指令...");e=m.tid;d=m.tname;h=1;f=true;vp.m.removeMark(g+e);var k=function(n){vp.v.log.info("定位指令发送成功！");a=$.parseJSON(n).sendTime;setTimeout(b,j)};var l=function(q){var o=$.parseJSON(q);var p="";for(var n=0;n<o.errorMsgs.length;n++){p+=o.errorMsgs[n]+"\n"}vp.v.log.error(p);alert(p);f=false};lbs.common.ajax("portal/send_locate_cmd.shtm",{terminalId:m.tid},k,l);k=null};var b=function(){vp.v.log.info("正在获取位置（第"+h+"次）...");h=h+1;var k=function(r){var m=false;try{var n=$.parseJSON(r);var l=n.locs;if(!$("#chk_show_blogloc")[0].checked){lbs.common.filterBlogLoc(l)}if(!lbs.common.isEmptyList(l.poss)){vp.v.log.info("获取位置成功!");f=false;var o=l.poss[l.poss.length-1];vp.v.cur_terminal.posChanged(o);var q={mkid:g+e,name:d,imgUrl:lbs.consts.PIMG.SINGLE,x:o.lng,y:o.lat,center:true};vp.m.showLoc(q);m=true}}finally{if(m){f=false}else{if(h<=i){setTimeout(b,j)}else{f=false;vp.v.log.error("位置获取失败，请尝试重新定位！")}}}};lbs.common.ajax("portal/get_latest_trace.shtm",{terminalId:e,lastTime:a},k);k=null;err_cb=null};vp.page.single_track={};vp.page.single_track.track=c})();