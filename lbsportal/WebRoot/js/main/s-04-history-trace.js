(function(){var p="mk";var E=800;var s=[E/0.7/0.7,E/0.7,E,E*0.7,E*0.7*0.7];var t="his-trace-";var u=2;var v=[];var j={};var h={};var z=null;var y="";var d=184;var q=324;var k=0;var F=null;var C=false;var e=null;var A="his-trace-start";var f="his-trace-end";var m=null;var g=null;var o=null;var b=false;var l=null;var n=function(I){var G=Math.floor(I/60);var H=(I-G*60);return(G<10?"0"+G:G)+":"+(H<10?"0"+H:H)};var c=function(L){var J=new Date();var H=J.getMonth()+1;var M=J.getDate();var I=["",J.getFullYear(),(H<10?"0"+H:H),(M<10?"0"+M:M)].join("");var K=L.replace(/-/g,"");if(parseInt(I)<parseInt(K)){x([]);return}if(h[K]){x(h[K]);return}$("#select_time_data_area").html("数据加载中...");var G=function(T){var ac=$.parseJSON(T);var W=ac.dateDataHint;var X=[];var Q,Z,U,Y,aa=-1;for(var S=0;S<W.length;S++){Q=W[S].gdate.substring(8);Z=Q.substring(0,2);U=Q.substring(2);Y=Math.floor((parseInt(Z,10)*60+parseInt(U,10))/8);if(aa!=Y){X.push(Y);aa=Y}}var O=[];var R=null,V=0,P,N=0,ab=-2;for(var S=0;S<X.length;S++){P=X[S];if(P==(ab)+1){N++}else{if(ab!=-2){R={left:V,width:N};O.push(R)}V=P;N=1}ab=P;if(S==X.length-1){R={left:V,width:N};O.push(R)}}h[K]=O;x(O)};lbs.common.ajax("portal/load_date_data_hint.shtm",{terminalSerialNo:z,date:L},G)};var x=function(I){$("#select_time_data_area").html("");var G='<div style="left: #left#px; width: #width#px;"></div>';var J=[];for(var H=0;H<I.length;H++){J.push(G.replace(/#left#/g,I[H].left).replace(/#width#/g,I[H].width))}$("#select_time_data_area").html(J.join(""))};var a=function(J,K){var I=new Date();var L=I.getMonth()+1;var H=["",I.getFullYear(),(L<10?"0"+L:L)].join("");var M=["",J,(K<10?"0"+K:K)].join("");if(parseInt(H)<parseInt(M)){return}if(j[M]){lbs_date_calendar.setDataGrid(j[M]);return}$("#p_hc_c_info").html("数据加载中...");var G=function(Q){var O=$.parseJSON(Q);var P=O.monthDataHint;var R=[];for(var N=0;N<P.length;N++){R[N]=P[N].gdate.replace(/-/g,"")}j[M]=R;lbs_date_calendar.setDataGrid(R);$("#p_hc_c_info").html("数据加载完成!")};lbs.common.ajax("portal/load_month_data_hint.shtm",{terminalSerialNo:z,yearMon:M},G)};var D=function(){vp.m.removeMark(e);vp.m.removeMark(A);vp.m.removeMark(f);for(var G=0;G<v.length;G++){vp.m.removeLine(t+G)}v=[];u=2;y=vp.v.cur_terminal.terminal_name;k=0;F=null;C=false};var r=function(){if(l!=null){window.clearTimeout(l);l=null}};var i=function(){var G=v[k];if(k==v.length-1){r();vp.m.drawLine({lid:t+k,xs:[F.lng,G.lng],ys:[F.lat,G.lat],color:lbs.common.getLineColor(G.speed)});vp.m.showLoc({mkid:f,name:"",imgUrl:lbs.consts.PIMG.END,x:G.lng,y:G.lat,inView:true});vp.m.showLoc({mkid:e,name:y,imgUrl:lbs.consts.PIMG.HISTORY,x:G.lng,y:G.lat,center:true});vp.v.cur_terminal.posChanged(G);window.setTimeout(function(){alert("回放结束！")},10);return}if(k==0){vp.m.showLoc({mkid:A,name:"",imgUrl:lbs.consts.PIMG.START,x:G.lng,y:G.lat,center:true})}else{vp.m.drawLine({lid:t+k,xs:[F.lng,G.lng],ys:[F.lat,G.lat],color:lbs.common.getLineColor(G.speed)});vp.m.showLoc({mkid:e,name:y,imgUrl:lbs.consts.PIMG.HISTORY,x:G.lng,y:G.lat,inView:true})}vp.v.cur_terminal.posChanged(G);k=k+1;F=G;r();if(!C){l=window.setTimeout(i,s[u])}};var B=function(H,I){var G=function(K){var M=$.parseJSON(K).locs;if(!$("#chk_show_blogloc")[0].checked){lbs.common.filterBlogLoc(M)}if(lbs.common.isEmptyList(M.poss)){vp.v.log.info("没有轨迹信息!");return}else{v=v.concat(M.poss);if(H){l=window.setTimeout(i,s[u]);$("#btn_show_histrace").trigger("click")}if(M.hasNext){B(false,M.lastTime)}var L=vp.m.mapConfig("zoom");if(L<=16){vp.m.mapConfig("zoom",16)}}};var J={terminalId:z,date:m,st:g,et:o,lastTime:I||""};lbs.common.ajax("portal/get_history_locations.shtm",J,G);J=null;G=null};var w=function(G){z=G;e=p+G;$("#panel_history_query").css({width:d+"px",height:q+"px"});$("#panel_history_query").draggable({handle:"h6"});$("#select_time").slider({range:true,min:0,max:1440,values:[0,1440],slide:function(H,I){$("#sp_tm_st").html(n(I.values[0]));$("#sp_tm_et").html(n(I.values[1]))}});$("#btn_show_histrace").click(function(){$("#panel_history_query").toggle(!b);b=!b;if(b){$("#panel_history_control").toggle(b);lbs_date_calendar.bindData()}});lbs_date_calendar.onDateClick=function(I){var H="日期："+I;if(H==$("#p_hc_c_info").html()){return}$("#p_hc_c_info").html(H);c(I)};lbs_date_calendar.onMonthChange=function(H,I){a(H,I)};$("#btn_query_play").click(function(){D();m=$("#his_date").val();if(lbs.common.isEmpty(m)){alert("请求选择日期！");return}g=$("#sp_tm_st").html();o=$("#sp_tm_et").html();B(true,"")});$("#btn_histrace_pause").click(function(){C=!C;if(C){r();$(this).html('<i class="icon-play"></i> ');$(this).attr("title","播放")}else{l=window.setTimeout(i,s[u]);$(this).html('<i class="icon-pause"></i> ');$(this).attr("title","暂停")}});$("#btn_histrace_backward").click(function(){if(u>0){u=u-1}});$("#btn_histrace_forward").click(function(){if(u<4){u=u+1}});$("#btn_histrace_clear").click(function(){r();D();$("#panel_history_control").toggle(false)})};vp.page.history={};vp.page.history.init=w})();